<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobile Network - –ó–≤–æ–Ω–∫–∏</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* –í—Å–µ –≤–∞—à–∏ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
        :root {
            --primary: #8A2BE2;
            --accent: #00FF7F;
            --background: #0A0A0A;
            --card-bg: #1A1A1A;
            --text-color: #FFFFFF;
            --text-secondary: #B0B0B0;
            --border-color: #333;
            --shadow: 0 4px 20px rgba(138, 43, 226, 0.2);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background: var(--background);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 400px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .screen {
            padding: 40px 30px;
            display: none;
        }

        .active {
            display: block;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            margin-bottom: 30px;
            font-size: 28px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .form-group {
            margin-bottom: 20px;
        }

        input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            background: var(--background);
            color: var(--text-color);
            transition: var(--transition);
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            color: var(--text-color);
            border: none;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .switch-form {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
        }

        .switch-form a {
            color: var(--accent);
            text-decoration: none;
            cursor: pointer;
        }

        .phone-number {
            background: var(--background);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            border: 2px solid var(--primary);
        }

        .phone-number h3 {
            color: var(--text-secondary);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .phone-number .number {
            font-size: 24px;
            font-weight: bold;
            color: var(--accent);
            letter-spacing: 2px;
        }

        .call-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .call-section input {
            flex: 1;
        }

        .call-section button {
            width: auto;
            padding: 15px 20px;
            background: var(--primary);
        }

        .call-status {
            text-align: center;
            padding: 20px;
            background: var(--background);
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            border: 2px solid transparent;
            transition: var(--transition);
        }

        .call-status.calling {
            border-color: var(--accent);
            background: rgba(0, 255, 127, 0.1);
        }

        .call-status.ringing {
            border-color: var(--primary);
            background: rgba(138, 43, 226, 0.1);
            animation: pulse 1s infinite;
        }

        .call-status.connected {
            border-color: var(--accent);
            background: rgba(0, 255, 127, 0.2);
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .user-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            background: var(--background);
        }

        .user-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
        }

        .user-item:hover {
            background: rgba(138, 43, 226, 0.1);
            transform: translateX(5px);
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-color);
        }

        .user-phone {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .call-button {
            background: var(--accent);
            color: var(--background);
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .call-button:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow);
        }

        .logout-btn {
            background: transparent;
            border: 2px solid var(--text-secondary);
            color: var(--text-secondary);
            margin-top: 20px;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--primary);
            color: var(--primary);
        }

        .call-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .call-controls button {
            flex: 1;
        }

        .accept-call {
            background: var(--accent);
            color: var(--background);
        }

        .reject-call {
            background: #ff4444;
            color: white;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent);
            margin-left: 10px;
        }

        .offline {
            background: var(--text-secondary);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–≤–æ–Ω–∫–∞ */
        .call-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .call-video-container {
            display: flex;
            gap: 20px;
            max-width: 800px;
            width: 100%;
            height: 60vh;
        }

        .call-video {
            flex: 1;
            border-radius: 16px;
            overflow: hidden;
            position: relative;
            background: #000;
        }

        .call-video video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .call-video.local video {
            transform: scaleX(-1);
        }

        .call-user-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 20px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .call-controls {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .call-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
        }

        .call-btn.mute {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .call-btn.end {
            background: linear-gradient(45deg, #FF416C, #FF4B2B);
            color: white;
        }

        .call-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow);
        }

        .call-timer {
            font-size: 18px;
            font-weight: 600;
            color: var(--accent);
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –≠–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
        <div id="registerScreen" class="screen active">
            <h1>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ —Å–µ—Ç–∏</h1>
            <form id="registerForm">
                <div class="form-group">
                    <input type="email" id="regEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
                </div>
                <div class="form-group">
                    <input type="text" id="regName" placeholder="–í–∞—à–µ –∏–º—è" required>
                </div>
                <button type="submit">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </form>
            <div class="switch-form">
                –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="showLogin()">–í–æ–π—Ç–∏</a>
            </div>
        </div>

        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
        <div id="loginScreen" class="screen">
            <h1>–í—Ö–æ–¥ –≤ —Å–µ—Ç—å</h1>
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
                </div>
                <button type="submit">–í–æ–π—Ç–∏</button>
            </form>
            <div class="switch-form">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω -->
        <div id="mainScreen" class="screen">
            <h1>–ú–æ–±–∏–ª—å–Ω–∞—è —Å–µ—Ç—å</h1>
            
            <div class="phone-number">
                <h3>–í–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</h3>
                <div class="number" id="userPhoneNumber">-</div>
            </div>
            
            <div class="call-section">
                <input type="text" id="callNumber" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –¥–ª—è –∑–≤–æ–Ω–∫–∞">
                <button onclick="makeCall()">üìû</button>
            </div>

            <div id="callStatus" class="call-status"></div>

            <h3 style="margin: 20px 0 10px 0; color: var(--text-secondary);">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ–Ω–ª–∞–π–Ω:</h3>
            <div id="userList" class="user-list"></div>

            <button class="logout-btn" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
        </div>
    </div>

    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞ -->
    <div class="call-container" id="callContainer">
        <div class="call-video-container">
            <div class="call-video remote">
                <video id="remoteVideo" autoplay playsinline></video>
                <div class="call-user-info">
                    <div class="user-avatar" id="remoteUserAvatar">U</div>
                    <div>
                        <div id="remoteUserName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                        <div class="call-timer" id="callTimer">00:00</div>
                    </div>
                </div>
            </div>
            <div class="call-video local">
                <video id="localVideo" autoplay muted playsinline></video>
                <div class="call-user-info">
                    <div class="user-avatar">–í—ã</div>
                </div>
            </div>
        </div>
        <div class="call-controls">
            <button class="call-btn mute" onclick="toggleMute()">
                <span id="muteIcon">üé§</span>
            </button>
            <button class="call-btn end" onclick="endCall()">
                <span>üìû</span>
            </button>
        </div>
    </div>

    <!-- –ê—É–¥–∏–æ –¥–ª—è —Ä–∏–Ω–≥—Ç–æ–Ω–∞ -->
    <audio id="ringtone" loop>
        <source src="https://assets.mixkit.co/active_storage/sfx/250/250-preview.mp3" type="audio/mpeg">
    </audio>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDX14zgvDk57Wy1q7WTrLCO1o8U1MdqP-w",
            authDomain: "doros-f9d89.firebaseapp.com",
            projectId: "doros-f9d89",
            storageBucket: "doros-f9d89.appspot.com",
            messagingSenderId: "351289560916",
            appId: "1:351289560916:web:c5ef1d0ab49cf451ca82c1",
            databaseURL: "https://doros-f9d89-default-rtdb.firebaseio.com/"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        let currentUser = null;
        let currentCall = null;
        let userPhoneNumber = null;
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let isMuted = false;
        let callStartTime = null;
        let callTimerInterval = null;
        let ringtone = document.getElementById('ringtone');
        let isCaller = false;

        // WebRTC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
        const configuration = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        function showRegister() {
            document.getElementById('registerScreen').classList.add('active');
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.remove('active');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —ç–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞
        function showLogin() {
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('registerScreen').classList.remove('active');
            document.getElementById('mainScreen').classList.remove('active');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π —ç–∫—Ä–∞–Ω
        function showMain() {
            document.getElementById('mainScreen').classList.add('active');
            document.getElementById('registerScreen').classList.remove('active');
            document.getElementById('loginScreen').classList.remove('active');
        }

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        function generatePhoneNumber() {
            const prefix = '+7';
            const firstPart = Math.floor(900 + Math.random() * 100).toString();
            const secondPart = Math.floor(100 + Math.random() * 900).toString();
            const thirdPart = Math.floor(1000 + Math.random() * 9000).toString();
            return `${prefix}${firstPart}-${secondPart}-${thirdPart}`;
        }

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        document.getElementById('registerForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const name = document.getElementById('regName').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    userPhoneNumber = generatePhoneNumber();
                    
                    return database.ref('users/' + user.uid).set({
                        name: name,
                        email: email,
                        phoneNumber: userPhoneNumber,
                        online: true,
                        lastSeen: Date.now()
                    });
                })
                .then(() => {
                    showMain();
                    loadUserData();
                    showNotification('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –í–∞—à –Ω–æ–º–µ—Ä: ' + userPhoneNumber);
                })
                .catch((error) => {
                    showNotification('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message, 'error');
                });
        });

        // –í—Ö–æ–¥
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            auth.signInWithEmailAndPassword(email, password)
                .then(() => {
                    showMain();
                    loadUserData();
                    showNotification('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
                })
                .catch((error) => {
                    showNotification('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message, 'error');
                });
        });

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        function loadUserData() {
            currentUser = auth.currentUser;
            if (currentUser) {
                database.ref('users/' + currentUser.uid).once('value')
                    .then((snapshot) => {
                        const userData = snapshot.val();
                        if (userData) {
                            userPhoneNumber = userData.phoneNumber;
                            document.getElementById('userPhoneNumber').textContent = userPhoneNumber;
                            
                            database.ref('users/' + currentUser.uid).update({
                                online: true,
                                lastSeen: Date.now()
                            });
                        }
                    });

                loadUsersList();
                listenForIncomingCalls();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        function loadUsersList() {
            database.ref('users').on('value', (snapshot) => {
                const users = snapshot.val();
                const userList = document.getElementById('userList');
                userList.innerHTML = '';

                if (!users) {
                    userList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</div>';
                    return;
                }

                for (const userId in users) {
                    if (userId !== currentUser.uid) {
                        const user = users[userId];
                        const userItem = document.createElement('div');
                        userItem.className = 'user-item';
                        userItem.innerHTML = `
                            <div class="user-info">
                                <div class="user-avatar">${user.name ? user.name.charAt(0).toUpperCase() : 'U'}</div>
                                <div class="user-details">
                                    <div class="user-name">${user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</div>
                                    <div class="user-phone">${user.phoneNumber}</div>
                                </div>
                                <div class="online-indicator ${user.online ? '' : 'offline'}"></div>
                            </div>
                            ${user.online ? `<button class="call-button" onclick="callUser('${user.phoneNumber}')">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>` : ''}
                        `;
                        userList.appendChild(userItem);
                    }
                }
            });
        }

        // –ó–≤–æ–Ω–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        function callUser(phoneNumber) {
            document.getElementById('callNumber').value = phoneNumber;
            makeCall();
        }

        // –°–æ–≤–µ—Ä—à–µ–Ω–∏–µ –∑–≤–æ–Ω–∫–∞
        function makeCall() {
            const targetNumber = document.getElementById('callNumber').value;
            if (!targetNumber) {
                showNotification('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞', 'error');
                return;
            }

            database.ref('users').orderByChild('phoneNumber').equalTo(targetNumber).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const users = snapshot.val();
                        const targetUserId = Object.keys(users)[0];
                        const targetUser = users[targetUserId];

                        if (!targetUser.online) {
                            showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ —Å–µ—Ç–∏', 'error');
                            return;
                        }

                        const callId = database.ref('calls').push().key;
                        currentCall = callId;
                        isCaller = true;

                        database.ref('calls/' + callId).set({
                            from: currentUser.uid,
                            to: targetUserId,
                            fromNumber: userPhoneNumber,
                            toNumber: targetNumber,
                            status: 'calling',
                            timestamp: Date.now(),
                            targetName: targetUser.name
                        });

                        const callStatus = document.getElementById('callStatus');
                        callStatus.style.display = 'block';
                        callStatus.className = 'call-status calling';
                        callStatus.innerHTML = `
                            <div>üìû –ó–≤–æ–Ω–æ–∫ –Ω–∞ ${targetNumber}</div>
                            <div style="margin-top: 10px; font-size: 14px; color: var(--text-secondary);">–û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞...</div>
                            <div class="call-controls">
                                <button class="reject-call" onclick="endCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
                            </div>
                        `;

                        // –°–ª—É—à–∞–µ–º WebRTC —Å–∏–≥–Ω–∞–ª—ã
                        listenForWebRTCSignals(callId);

                        database.ref('calls/' + callId).on('value', (callSnapshot) => {
                            const callData = callSnapshot.val();
                            if (callData) {
                                if (callData.status === 'answered') {
                                    startVideoCall(callId, callData);
                                } else if (callData.status === 'ended' || callData.status === 'rejected') {
                                    endCall();
                                }
                            }
                        });

                    } else {
                        showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    }
                });
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ PeerConnection
        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(configuration);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–æ—Ç–æ–∫
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
            
            // –ü–æ–ª—É—á–∞–µ–º —É–¥–∞–ª–µ–Ω–Ω—ã–π –ø–æ—Ç–æ–∫
            peerConnection.ontrack = (event) => {
                remoteStream = event.streams[0];
                document.getElementById('remoteVideo').srcObject = remoteStream;
            };
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            peerConnection.onicecandidate = (event) => {
                if (event.candidate && currentCall) {
                    database.ref('calls/' + currentCall + '/iceCandidates').push({
                        candidate: event.candidate,
                        from: currentUser.uid
                    });
                }
            };
            
            return peerConnection;
        }

        // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ WebRTC —Å–∏–≥–Ω–∞–ª–æ–≤
        function listenForWebRTCSignals(callId) {
            // –°–ª—É—à–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è (offers)
            database.ref('calls/' + callId + '/offer').on('value', async (snapshot) => {
                const offer = snapshot.val();
                if (offer && !isCaller) {
                    await peerConnection.setRemoteDescription(offer);
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    database.ref('calls/' + callId + '/answer').set(answer);
                }
            });

            // –°–ª—É—à–∞–µ–º –æ—Ç–≤–µ—Ç—ã (answers)
            database.ref('calls/' + callId + '/answer').on('value', async (snapshot) => {
                const answer = snapshot.val();
                if (answer && isCaller) {
                    await peerConnection.setRemoteDescription(answer);
                }
            });

            // –°–ª—É—à–∞–µ–º ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
            database.ref('calls/' + callId + '/iceCandidates').on('child_added', async (snapshot) => {
                const candidateData = snapshot.val();
                if (candidateData && candidateData.from !== currentUser.uid) {
                    await peerConnection.addIceCandidate(new RTCIceCandidate(candidateData.candidate));
                }
            });
        }

        // –ù–∞—á–∞—Ç—å –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫
        async function startVideoCall(callId, callData) {
            try {
                // –ü–æ–ª—É—á–∞–µ–º –º–µ–¥–∏–∞–ø–æ—Ç–æ–∫
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                // –°–æ–∑–¥–∞–µ–º PeerConnection
                peerConnection = createPeerConnection();

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∑–≤–æ–Ω–∫–∞
                document.getElementById('callContainer').style.display = 'flex';
                document.getElementById('localVideo').srcObject = localStream;

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–µ
                document.getElementById('remoteUserName').textContent = callData.targetName || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                document.getElementById('remoteUserAvatar').textContent = callData.targetName ? callData.targetName.charAt(0).toUpperCase() : 'U';

                // –ï—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä, —Å–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ
                if (isCaller) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    database.ref('calls/' + callId + '/offer').set(offer);
                }

                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                startCallTimer();

                showNotification('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–∞:', error);
                showNotification('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
                endCall();
            }
        }

        // –ó–∞–ø—É—Å–∫ —Ç–∞–π–º–µ—Ä–∞ –∑–≤–æ–Ω–∫–∞
        function startCallTimer() {
            callStartTime = Date.now();
            callTimerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const seconds = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('callTimer').textContent = `${minutes}:${seconds}`;
            }, 1000);
        }

        // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –∑–≤–æ–Ω–∫–∞
        function stopCallTimer() {
            if (callTimerInterval) {
                clearInterval(callTimerInterval);
                callTimerInterval = null;
            }
            document.getElementById('callTimer').textContent = '00:00';
        }

        // –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω
        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    isMuted = !audioTrack.enabled;
                    audioTrack.enabled = !isMuted;
                    
                    const icon = document.getElementById('muteIcon');
                    icon.textContent = isMuted ? 'üîá' : 'üé§';
                    
                    showNotification(isMuted ? '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω' : '–ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á–µ–Ω');
                }
            }
        }

        // –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
        function listenForIncomingCalls() {
            database.ref('calls').on('child_added', (snapshot) => {
                const callData = snapshot.val();
                if (callData.to === currentUser.uid && callData.status === 'calling') {
                    showIncomingCall(snapshot.key, callData);
                }
            });
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫
        function showIncomingCall(callId, callData) {
            ringtone.play().catch(e => console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ'));

            const callStatus = document.getElementById('callStatus');
            callStatus.style.display = 'block';
            callStatus.className = 'call-status ringing';
            callStatus.innerHTML = `
                <div>üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫</div>
                <div style="margin-top: 5px; font-size: 18px; color: var(--accent);">${callData.fromNumber}</div>
                <div style="margin-top: 10px; font-size: 14px; color: var(--text-secondary);">–ó–≤–æ–Ω–∏—Ç –≤–∞–º...</div>
                <div class="call-controls">
                    <button class="accept-call" onclick="answerCall('${callId}')">–ü—Ä–∏–Ω—è—Ç—å</button>
                    <button class="reject-call" onclick="rejectCall('${callId}')">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                </div>
            `;
            currentCall = callId;
        }

        // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–≤–æ–Ω–æ–∫
        function answerCall(callId) {
            ringtone.pause();
            ringtone.currentTime = 0;

            database.ref('calls/' + callId).update({
                status: 'answered'
            });

            database.ref('calls/' + callId).once('value').then((snapshot) => {
                const callData = snapshot.val();
                startVideoCall(callId, callData);
            });

            showNotification('–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –Ω–∞ –∑–≤–æ–Ω–æ–∫');
        }

        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function rejectCall(callId) {
            ringtone.pause();
            ringtone.currentTime = 0;

            database.ref('calls/' + callId).update({
                status: 'rejected'
            });
            document.getElementById('callStatus').style.display = 'none';
            currentCall = null;
            showNotification('–ó–≤–æ–Ω–æ–∫ –æ—Ç–∫–ª–æ–Ω–µ–Ω');
        }

        // –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫
        function endCall() {
            ringtone.pause();
            ringtone.currentTime = 0;

            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }

            document.getElementById('callContainer').style.display = 'none';
            document.getElementById('callStatus').style.display = 'none';

            stopCallTimer();

            if (currentCall) {
                database.ref('calls/' + currentCall).update({
                    status: 'ended'
                });
                
                // –û—á–∏—â–∞–µ–º WebRTC –¥–∞–Ω–Ω—ã–µ
                database.ref('calls/' + currentCall + '/offer').remove();
                database.ref('calls/' + currentCall + '/answer').remove();
                database.ref('calls/' + currentCall + '/iceCandidates').remove();
                
                currentCall = null;
            }

            isCaller = false;
            showNotification('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // –í—ã—Ö–æ–¥
        function logout() {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
            if (currentCall) {
                endCall();
            }
            auth.signOut();
            showLogin();
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }

        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'error' ? '#ff4444' : 'var(--primary)'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: var(--shadow);
                z-index: 1000;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                loadUserData();
            } else {
                showLogin();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∫–ª–∞–¥–∫–∏
        window.addEventListener('beforeunload', () => {
            if (currentUser) {
                database.ref('users/' + currentUser.uid).update({
                    online: false,
                    lastSeen: Date.now()
                });
            }
            if (currentCall) {
                endCall();
            }
        });

        // –°—Ç–∏–ª—å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
